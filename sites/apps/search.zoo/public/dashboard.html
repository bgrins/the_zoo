<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Search - Zoo</title>
    <style>
    body {
      font-family:
        -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }
    .section {
      margin-bottom: 40px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 6px;
    }
    .section h2 {
      margin-top: 0;
      color: #444;
    }
    input, button, select {
      padding: 10px;
      margin: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    input[type="text"] {
      width: 300px;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      padding: 10px 20px;
    }
    button:hover {
      background: #0056b3;
    }
    .results {
      margin-top: 20px;
      padding: 15px;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      max-height: 400px;
      overflow-y: auto;
    }
    .status {
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 20px;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    .info-card {
      padding: 15px;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
    }
    .info-card h3 {
      margin: 0 0 10px 0;
      color: #555;
      font-size: 14px;
    }
    .info-card p {
      margin: 0;
      font-size: 24px;
      font-weight: bold;
      color: #007bff;
    }
    pre {
      background: #f4f4f4;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
    }
    .search-result {
      margin-bottom: 15px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
    }
    .search-result h4 {
      margin: 0 0 5px 0;
      color: #333;
    }
    .search-result p {
      margin: 0;
      color: #666;
      font-size: 14px;
    }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîç New Search</h1>
      <p class="subtitle">
        MeiliSearch Frontend - <a href="http://search-api.zoo" target="_blank"
        >API: search-api.zoo</a>
      </p>

      <div id="status"></div>

      <div class="section">
        <h2>Server Info</h2>
        <div id="serverInfo">Loading...</div>
      </div>

      <div class="section">
        <h2>Create Index</h2>
        <input
          type="text"
          id="indexName"
          placeholder="Index name (e.g., movies)"
        >
        <input type="text" id="primaryKey" placeholder="Primary key (e.g., id)">
        <button onclick="createIndex()">Create Index</button>
        <div id="createResult" class="results" style="display: none"></div>
      </div>

      <div class="section">
        <h2>Add Documents</h2>
        <select id="indexSelect">
          <option value="">Select an index...</option>
        </select>
        <br>
        <textarea
          id="documents"
          rows="6"
          style="width: 100%; margin-top: 10px"
          placeholder='[{"id": 1, "title": "Example", "description": "Sample document"}]'
        ></textarea>
        <br>
        <button onclick="addDocuments()">Add Documents</button>
        <div id="addResult" class="results" style="display: none"></div>
      </div>

      <div class="section">
        <h2>Search</h2>
        <select id="searchIndexSelect">
          <option value="">Select an index...</option>
        </select>
        <input type="text" id="searchQuery" placeholder="Search query...">
        <button onclick="performSearch()">Search</button>
        <div id="searchResults" class="results" style="display: none"></div>
      </div>
    </div>

    <script>
    // Load server info on page load
window.onload = async () => {
  await loadServerInfo();
  await loadIndexes();
};

async function loadServerInfo() {
  try {
    const response = await fetch("/api/info");
    const data = await response.json();

    if (response.ok) {
      const infoHtml = `
                        <div class="info-grid">
                            <div class="info-card">
                                <h3>Status</h3>
                                <p style="color: ${data.health.status === "available" ? "#28a745" : "#dc3545"}">
                                    ${data.health.status}
                                </p>
                            </div>
                            <div class="info-card">
                                <h3>Version</h3>
                                <p>${data.version.pkgVersion}</p>
                            </div>
                            <div class="info-card">
                                <h3>Indexes</h3>
                                <p>${Object.keys(data.stats.indexes).length}</p>
                            </div>
                            <div class="info-card">
                                <h3>Database Size</h3>
                                <p>${(data.stats.databaseSize / 1024 / 1024).toFixed(2)} MB</p>
                            </div>
                        </div>
                    `;
      document.getElementById("serverInfo").innerHTML = infoHtml;
      showStatus("MeiliSearch connected successfully", "success");
    } else {
      throw new Error(data.error || "Failed to connect");
    }
  } catch (error) {
    document.getElementById("serverInfo").innerHTML =
      `<p style="color: red;">Error: ${error.message}</p>`;
    showStatus("Failed to connect to MeiliSearch", "error");
  }
}

async function loadIndexes() {
  try {
    const response = await fetch("/api/indexes");
    const data = await response.json();

    if (response.ok && data.results) {
      const selects = ["indexSelect", "searchIndexSelect"];
      selects.forEach((selectId) => {
        const select = document.getElementById(selectId);
        select.innerHTML = '<option value="">Select an index...</option>';
        data.results.forEach((index) => {
          select.innerHTML += `<option value="${index.uid}">${index.uid}</option>`;
        });
      });
    }
  } catch (error) {
    console.error("Failed to load indexes:", error);
  }
}

async function createIndex() {
  const uid = document.getElementById("indexName").value;
  const primaryKey = document.getElementById("primaryKey").value;

  if (!uid) {
    showStatus("Please enter an index name", "error");
    return;
  }

  try {
    const response = await fetch("/api/indexes", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ uid, primaryKey }),
    });

    const data = await response.json();

    if (response.ok) {
      document.getElementById("createResult").style.display = "block";
      document.getElementById("createResult").innerHTML =
        `<pre>${JSON.stringify(data, null, 2)}</pre>`;
      showStatus("Index created successfully", "success");
      await loadIndexes();
      document.getElementById("indexName").value = "";
      document.getElementById("primaryKey").value = "";
    } else {
      throw new Error(data.error || "Failed to create index");
    }
  } catch (error) {
    showStatus(`Error: ${error.message}`, "error");
  }
}

async function addDocuments() {
  const indexUid = document.getElementById("indexSelect").value;
  const documentsText = document.getElementById("documents").value;

  if (!indexUid) {
    showStatus("Please select an index", "error");
    return;
  }

  if (!documentsText) {
    showStatus("Please enter documents", "error");
    return;
  }

  try {
    const documents = JSON.parse(documentsText);
    const response = await fetch(`/api/indexes/${indexUid}/documents`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(documents),
    });

    const data = await response.json();

    if (response.ok) {
      document.getElementById("addResult").style.display = "block";
      document.getElementById("addResult").innerHTML =
        `<pre>${JSON.stringify(data, null, 2)}</pre>`;
      showStatus("Documents added successfully", "success");
      document.getElementById("documents").value = "";
    } else {
      throw new Error(data.error || "Failed to add documents");
    }
  } catch (error) {
    showStatus(`Error: ${error.message}`, "error");
  }
}

async function performSearch() {
  const indexUid = document.getElementById("searchIndexSelect").value;
  const query = document.getElementById("searchQuery").value;

  if (!indexUid) {
    showStatus("Please select an index", "error");
    return;
  }

  try {
    const response = await fetch(`/api/search/${indexUid}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ query }),
    });

    const data = await response.json();

    if (response.ok) {
      document.getElementById("searchResults").style.display = "block";

      if (data.hits && data.hits.length > 0) {
        let resultsHtml = `<p>Found ${data.estimatedTotalHits} results (${data.processingTimeMs}ms)</p>`;
        data.hits.forEach((hit) => {
          resultsHtml += `
                                <div class="search-result">
                                    <h4>${hit.title || hit.name || "No title"}</h4>
                                    <p>${hit.description || JSON.stringify(hit).substring(0, 200)}...</p>
                                </div>
                            `;
        });
        document.getElementById("searchResults").innerHTML = resultsHtml;
      } else {
        document.getElementById("searchResults").innerHTML =
          "<p>No results found</p>";
      }
    } else {
      throw new Error(data.error || "Search failed");
    }
  } catch (error) {
    showStatus(`Error: ${error.message}`, "error");
  }
}

function showStatus(message, type) {
  const status = document.getElementById("status");
  status.className = `status ${type}`;
  status.textContent = message;
  status.style.display = "block";

  setTimeout(() => {
    status.style.display = "none";
  }, 5000);
}

// Sample data for testing
function loadSampleData() {
  document.getElementById("documents").value = JSON.stringify(
    [
      {
        id: 1,
        title: "The Great Gatsby",
        author: "F. Scott Fitzgerald",
        description: "A classic American novel set in the Jazz Age",
      },
      {
        id: 2,
        title: "To Kill a Mockingbird",
        author: "Harper Lee",
        description:
          "A story of racial injustice and childhood innocence",
      },
      {
        id: 3,
        title: "1984",
        author: "George Orwell",
        description: "A dystopian social science fiction novel",
      },
      {
        id: 4,
        title: "Pride and Prejudice",
        author: "Jane Austen",
        description: "A romantic novel of manners",
      },
      {
        id: 5,
        title: "The Catcher in the Rye",
        author: "J.D. Salinger",
        description: "A story about teenage rebellion and angst",
      },
    ],
    null,
    2,
  );
}
    </script>
  </body>
</html>
