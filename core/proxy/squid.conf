# Squid proxy configuration for .zoo domain isolation
# This proxy ONLY allows access to *.zoo domains - all other traffic is blocked

http_port 3128

# Basic authentication (configured via PROXY_USER/PROXY_PASS env vars)
auth_param basic program /usr/lib/squid/basic_ncsa_auth /etc/squid/passwords
auth_param basic realm Zoo Proxy
auth_param basic credentialsttl 2 hours
acl authenticated proxy_auth REQUIRED

# Disable /etc/hosts to ensure DNS queries go through configured resolvers
hosts_file none

# Security: Only allow standard web ports
acl SSL_ports port 443
acl Safe_ports port 80
acl Safe_ports port 443
acl CONNECT method CONNECT
acl CONNECT_ports port 80  # Allow CONNECT for HTTP (needed for undici ProxyAgent)
acl CONNECT_ports port 443 # Allow CONNECT for HTTPS

# CRITICAL: Only allow domains ending in .zoo
# This regex matches any domain/subdomain ending with .zoo (e.g., app.zoo, test.app.zoo)
acl zoo_domains dstdom_regex \.zoo$

# Allow external domains through the proxy (DNS resolves them to Caddy, not the internet)
acl external_domains dstdomain secure.gravatar.com pdat.matterlytics.com api.rudderlabs.com

# Access rules - order matters, first match wins
http_access deny !Safe_ports              # Block non-standard ports
http_access deny CONNECT !CONNECT_ports   # Allow tunneling only on ports 80 and 443
http_access allow authenticated zoo_domains  # Allow authenticated users to access .zoo domains
http_access allow authenticated external_domains  # Allow authenticated users to access external compatibility domains
http_access deny all                      # Default deny

# Disable caching for development environments
# Remove this line for production if caching is desired
cache deny all

# Client IP handling - preserve original client IP
forwarded_for on          # Add X-Forwarded-For with client IP
via off                   # Don't reveal proxy presence in Via header

# Trust X-Forwarded-For from localhost connections (test runner)
acl localhost src 127.0.0.1/32 ::1
follow_x_forwarded_for allow localhost
follow_x_forwarded_for deny all

# Ensure we append to existing X-Forwarded-For headers
request_header_access X-Forwarded-For allow all

# Logging configuration
access_log daemon:/var/log/squid/access.log squid
cache_log /var/log/squid/cache.log

# Debug options for troubleshooting (comment out in production)
# 28,3: Access control decisions
# 33,3: Client request processing
debug_options 28,3 33,3

# Performance tuning for development environment
dns_v4_first on           # Prefer IPv4 for faster DNS in most environments
dns_timeout 2 seconds     # Fail fast on DNS queries
forward_timeout 30 seconds
connect_timeout 30 seconds

# Security headers to add to all responses
reply_header_add X-Content-Type-Options "nosniff" all
reply_header_add X-Frame-Options "SAMEORIGIN" all