networks:
  zoo-network:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: ${ZOO_SUBNET:-172.20.0.0/16}

  # used for proxy to accept connections & bind to port
  public:
    driver: bridge
    ipam:
      config:
        - subnet: ${ZOO_PUBLIC_SUBNET:-172.21.0.0/30}

# Common dependencies for all non-core services
x-common-depends-on: &common-deps
  coredns:
    condition: service_healthy
  caddy:
    condition: service_healthy
  mysql:
    condition: service_healthy
  proxy:
    condition: service_healthy
  postgres:
    condition: service_healthy
  redis:
    condition: service_healthy
  stalwart:
    condition: service_healthy
  hydra:
    condition: service_healthy

# Common configuration for all zoo services
x-zoo-common: &zoo-common
  restart: always
  dns:
    - ${ZOO_DNS_IP:-172.20.250.2}
  networks:
    - zoo-network
  depends_on: *common-deps

# Common health check configuration for on-demand services
x-zoo-healthcheck: &zoo-healthcheck
  interval: 60s
  timeout: 5s
  retries: 3
  start_period: 15s
  start_interval: .3s

services:
  #
  # Core Services:
  #
  coredns:
    image: coredns/coredns:1.11.1
    restart: always
    labels:
      - "zoo.core=true"
      - "zoo.description=CoreDNS"
    command: ["-conf", "/etc/coredns/Corefile"]
    environment:
      - ZOO_CADDY_IP=${ZOO_CADDY_IP:-172.20.250.3}
      - ZOO_PROXY_IP=${ZOO_PROXY_IP:-172.20.250.4}
    volumes:
      - ./core/coredns/Corefile:/etc/coredns/Corefile:ro
    networks:
      zoo-network:
        ipv4_address: ${ZOO_DNS_IP:-172.20.250.2}
    healthcheck:
      test: ["CMD", "/coredns", "-version"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 20s
      start_interval: 500ms

  caddy:
    build:
      context: ./core
      dockerfile: ./caddy/Dockerfile
      cache_from:
        - type=local,src=/tmp/.buildx-cache-caddy
      cache_to:
        - type=local,dest=/tmp/.buildx-cache-caddy,mode=max
    restart: always
    labels:
      - "zoo.core=true"
      - "zoo.description=Caddy Reverse Proxy"
    environment:
      # Chaos mode: Set to "1" to enable failure injection
      - CHAOS_MODE=0
      # Fail injector probability (0.0-1.0) when CHAOS_MODE=1
      # Set to a value like 0.2 to inject 20% failures for testing
      - CHAOS_MODE_FAIL_PROBABILITY=0.2
      # Random seed for reproducible failure patterns (optional)
      # Uncomment the line below to use a fixed seed for deterministic testing
      # CHAOS_MODE_FAIL_SEED: "12345"
      # IP addresses for network configuration
      - ZOO_PROXY_IP=${ZOO_PROXY_IP:-172.20.250.4}
      # HTTPS-only mode for static sites
      - ZOO_STATIC_HTTPS_ONLY=${ZOO_STATIC_HTTPS_ONLY:-true}
      # HTTPS-only mode for all sites (overrides individual settings)
      - ZOO_ALL_HTTPS_ONLY=${ZOO_ALL_HTTPS_ONLY:-false}
    volumes:
      - ./core/caddy/Caddyfile:/etc/caddy/Caddyfile
      - ./core/SITES.yaml:/etc/caddy/SITES.yaml:ro
      - ./sites/static:/static:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - caddy_data:/root/.local/share/caddy
    dns:
      - ${ZOO_DNS_IP:-172.20.250.2}
    networks:
      zoo-network:
        ipv4_address: ${ZOO_CADDY_IP:-172.20.250.3}
    depends_on:
      - coredns
    healthcheck:
      test: ["CMD", "wget", "-q", "-O-", "http://localhost:80/health"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 20s
      start_interval: 1s
  proxy:
    build: ./core/proxy
    restart: always
    labels:
      - "zoo.core=true"
      - "zoo.description=Squid Forward Proxy"
    ports:
      - "${ZOO_PROXY_PORT:-3128}:3128"
    environment:
      # Optional: Set PROXY_USER and PROXY_PASS for basic authentication
      - PROXY_USER=${PROXY_USER:-}
      - PROXY_PASS=${PROXY_PASS:-}
    dns:
      - ${ZOO_DNS_IP:-172.20.250.2}
    networks:
      zoo-network:
        ipv4_address: ${ZOO_PROXY_IP:-172.20.250.4}
      public:
    depends_on:
      caddy:
        condition: service_healthy
      coredns:
        condition: service_healthy
    healthcheck:
      test: [
        "CMD",
        "sh",
        "-c",
        "if [ -n \"$PROXY_USER\" ] && [ -n \"$PROXY_PASS\" ]; then curl -f --proxy http://$PROXY_USER:$PROXY_PASS@localhost:3128 http://status.zoo; else curl -f --proxy http://localhost:3128 http://status.zoo; fi",
      ]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 20s
      start_interval: 1s

  redis:
    image: redis:7-alpine
    restart: always
    labels:
      - "zoo.core=true"
      - "zoo.description=Redis"
    command: redis-server --save "" --appendonly no
    networks:
      - zoo-network
    depends_on:
      coredns:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 20s
      start_interval: 1s

  stalwart:
    build: ./core/stalwart
    restart: always
    environment:
      - PORT=8080
      - ADMIN_PASSWORD=zoo-mail-admin-pw
    dns:
      - ${ZOO_DNS_IP:-172.20.250.2}
    networks:
      - zoo-network
    depends_on:
      coredns:
        condition: service_healthy
      postgres:
        condition: service_healthy
      caddy:
        condition: service_healthy
    labels:
      - "zoo.core=true"
      - "zoo.description=Stalwart Mail Server"
      - "zoo.domains=mail-api.zoo:8080"
    healthcheck:
      test: ["CMD", "sh", "-c", "echo QUIT | nc localhost 25 || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 20s
      start_interval: 1s

  postgres:
    build:
      context: ./core/postgres
      args:
        - ZOO_NO_SEED=${ZOO_NO_SEED:-false}
    restart: always
    labels:
      - "zoo.core=true"
      - "zoo.description=PostgreSQL"
    networks:
      - zoo-network
    depends_on:
      coredns:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d zoodb"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 20s
      start_interval: 500ms

  mysql:
    build:
      context: ./core/mysql
      args:
        - ZOO_NO_SEED=${ZOO_NO_SEED:-false}
    restart: always
    labels:
      - "zoo.core=true"
      - "zoo.description=MySQL"
    networks:
      - zoo-network
    depends_on:
      coredns:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 20s
      start_interval: 1s

  hydra:
    build: ./core/hydra
    restart: always
    environment:
      - DSN=postgres://auth_user:auth_pw@postgres.zoo/auth_db?sslmode=disable
      - URLS_SELF_ISSUER=http://auth.zoo
      - URLS_CONSENT=http://auth.zoo/consent
      - URLS_LOGIN=http://auth.zoo/login
      - URLS_LOGOUT=http://auth.zoo/logout
      - URLS_POST_LOGOUT_REDIRECT=http://auth.zoo/
      - SECRETS_SYSTEM=youReallyNeedToChangeThis
      - OIDC_SUBJECT_IDENTIFIERS_SUPPORTED_TYPES=public
      - SERVE_PUBLIC_CORS_ENABLED=true
      - SERVE_PUBLIC_CORS_ALLOWED_ORIGINS=https://*.zoo,http://*.zoo
      - PORT=4444
    dns:
      - ${ZOO_DNS_IP:-172.20.250.2}
    networks:
      - zoo-network
    depends_on:
      coredns:
        condition: service_healthy
      caddy:
        condition: service_healthy
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "/healthcheck.sh"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 20s
      start_interval: 1s
    labels:
      - "zoo.core=true"
      - "zoo.description=Ory Hydra"
      - "zoo.domains=admin.auth.zoo:4445"

  auth-zoo:
    <<: *zoo-common
    build: ./sites/apps/auth.zoo
    environment:
      - PORT=3000
      - NODE_ENV=development
      - SMTP_HOST=stalwart
      - SMTP_PORT=25
      - SMTP_FROM=noreply@auth.zoo
      - SSL_CERT_FILE=/caddy-ca/pki/authorities/local/root.crt
    volumes:
      - ./sites/apps/auth.zoo:/app
      - auth_zoo_modules:/app/node_modules
      - ./core/SITES.yaml:/app/SITES.yaml:ro
      - caddy_data:/caddy-ca:ro
    labels:
      - "zoo.domains=auth.zoo"

  secure-gravatar-com:
    <<: *zoo-common
    build: ./sites/apps/secure.gravatar.com
    environment:
      - SSL_CERT_FILE=/caddy-ca/pki/authorities/local/root.crt
    volumes:
      - caddy_data:/caddy-ca:ro
    labels:
      - "zoo.domains=secure.gravatar.com:8080"
      - "zoo.description=Gravatar avatar image service"
      - "zoo.icon=ðŸ‘¤"
    healthcheck:
      <<: *zoo-healthcheck
      test: ["CMD", "wget", "-q", "-O-", "http://localhost:8080/avatar/test"]
    profiles:
      - on-demand

  #
  # Applications:
  #

  # From https://github.com/bgrins/vwa_classifieds_optimized/:
  # blake.sullivan@gmail.com / Password.123
  vwa-classifieds:
    <<: *zoo-common
    image: ghcr.io/bgrins/vwa_classifieds_web:latest
    environment:
      - PORT=9980
      - CLASSIFIEDS=//classifieds.zoo/
      - RESET_TOKEN=4b61655535e7ed388f0d40a93600254c
      - DB_HOST=mysql
      - DB_USER=vwa-classifieds_user
      - DB_PASSWORD=vwa-classifieds_pw
      - DB_NAME=vwa-classifieds_db
      - DB_TABLE_PREFIX=oc_
      - SSL_CERT_FILE=/caddy-ca/pki/authorities/local/root.crt
    volumes:
      - caddy_data:/caddy-ca:ro
    labels:
      - "zoo.domains=classifieds.zoo"
      - "zoo.description=Classified ads marketplace from VisualWebArena"
      - "zoo.icon=ðŸ›’"
    healthcheck:
      <<: *zoo-healthcheck
      # -L follows redirects (app redirects localhost to classifieds.zoo)
      # --resolve forces classifieds.zoo to resolve to localhost
      test: [
        "CMD",
        "curl",
        "-f",
        "-s",
        "-L",
        "--resolve",
        "classifieds.zoo:9980:127.0.0.1",
        "http://localhost:9980/",
      ]
    profiles:
      - on-demand

  wiki-zoo:
    <<: *zoo-common
    build:
      context: ./sites/apps/wiki.zoo
    labels:
      - "zoo.domains=wiki.zoo"
      - "zoo.description=Offline Wikipedia reader and knowledge base"
      - "zoo.icon=ðŸ“š"
    healthcheck:
      <<: *zoo-healthcheck
      test: ["CMD", "nc", "-z", "0.0.0.0", "8080"]
    command:
      - "--customIndex /data/index.html --blockexternal *.zim"
    environment:
      - PORT=8080
      - SSL_CERT_FILE=/caddy-ca/pki/authorities/local/root.crt
    volumes:
      - caddy_data:/caddy-ca:ro
    profiles:
      - on-demand

  misc-zoo:
    <<: *zoo-common
    build: ./sites/apps/misc.zoo
    environment:
      - SSL_CERT_FILE=/caddy-ca/pki/authorities/local/root.crt
    volumes:
      - caddy_data:/caddy-ca:ro
    labels:
      - "zoo.domains=misc.zoo"
      - "zoo.description=Miscellaneous utilities and test endpoints"
      - "zoo.icon=ðŸ”§"
    healthcheck:
      <<: *zoo-healthcheck
      test: [
        "CMD",
        "wget",
        "-q",
        "-O-",
        "http://localhost:3000/health",
      ]
    profiles:
      - on-demand

  miniflux:
    <<: *zoo-common
    image: miniflux/miniflux:2.2.9
    environment:
      - DATABASE_URL=postgres://miniflux_user:miniflux_pw@postgres.zoo/miniflux_db?sslmode=disable
      - RUN_MIGRATIONS=1
      - CREATE_ADMIN=1
      - ADMIN_USERNAME=admin
      - ADMIN_PASSWORD=zoopassword
      - PORT=8080
      # OAuth2/OIDC Configuration
      - OAUTH2_PROVIDER=oidc
      - OAUTH2_CLIENT_ID=miniflux
      - OAUTH2_CLIENT_SECRET=miniflux-oauth-secret
      - OAUTH2_REDIRECT_URL=http://miniflux.zoo/oauth2/oidc/callback
      - OAUTH2_OIDC_DISCOVERY_ENDPOINT=http://auth.zoo
      - OAUTH2_OIDC_PROVIDER_NAME=Zoo Auth
      - OAUTH2_USER_CREATION=1
      - SSL_CERT_FILE=/caddy-ca/pki/authorities/local/root.crt
    volumes:
      - caddy_data:/caddy-ca:ro
    labels:
      - "zoo.domains=miniflux.zoo"
      - "zoo.description=Minimalist feed reader with RSS/Atom support"
      - "zoo.icon=ðŸ“°"
    healthcheck:
      <<: *zoo-healthcheck
      test: [
        "CMD",
        "wget",
        "-q",
        "-O-",
        "http://localhost:8080",
      ]
    profiles:
      - on-demand

  snappymail-zoo:
    <<: *zoo-common
    build: ./sites/apps/snappymail.zoo
    environment:
      - PORT=8888
      - UPLOAD_MAX_SIZE=25M
      - LOG_TO_STDOUT=true
      - ADMIN_USER=admin
      - ADMIN_PASS=admin123
      - SSL_CERT_FILE=/caddy-ca/pki/authorities/local/root.crt
    volumes:
      - caddy_data:/caddy-ca:ro
    labels:
      - "zoo.domains=snappymail.zoo"
      - "zoo.description=Modern webmail client with clean interface"
      - "zoo.icon=âœ‰ï¸"
    healthcheck:
      <<: *zoo-healthcheck
      test: [
        "CMD",
        "curl",
        "-f",
        "-s",
        "-o",
        "/dev/null",
        "http://localhost:8888",
      ]
    profiles:
      - on-demand

  # alex.lee@snappymail.zoo / Password.123
  focalboard-zoo:
    <<: *zoo-common
    image: mattermost/focalboard:7.11.4
    environment:
      - PORT=8000
      - FOCALBOARD_PORT=8000
      - FOCALBOARD_DBTYPE=postgres
      - FOCALBOARD_DBCONFIG=postgres://focalboard_user:focalboard_pw@postgres.zoo/focalboard_db?sslmode=disable
      - SSL_CERT_FILE=/caddy-ca/pki/authorities/local/root.crt
    volumes:
      - caddy_data:/caddy-ca:ro
    labels:
      - "zoo.domains=focalboard.zoo:8000"
      - "zoo.description=Open source project management and kanban boards"
      - "zoo.icon=ðŸ“Š"
    profiles:
      - on-demand

  excalidraw-zoo:
    <<: *zoo-common
    image: excalidraw/excalidraw:sha-4bfc5bb
    environment:
      - SSL_CERT_FILE=/caddy-ca/pki/authorities/local/root.crt
    volumes:
      - caddy_data:/caddy-ca:ro
    labels:
      - "zoo.domains=excalidraw.zoo:80"
      - "zoo.description=Virtual whiteboard for sketching diagrams"
      - "zoo.icon=âœï¸"
    healthcheck:
      <<: *zoo-healthcheck
      test: [
        "CMD",
        "wget",
        "-q",
        "-O-",
        "http://localhost:80",
      ]
    profiles:
      - on-demand

  gitea-zoo:
    <<: *zoo-common
    build: ./sites/apps/gitea.zoo
    environment:
      - ZOO_NO_SEED=${ZOO_NO_SEED:-false}
      - GITEA__database__DB_TYPE=postgres
      - GITEA__database__HOST=postgres.zoo:5432
      - GITEA__database__NAME=gitea_db
      - GITEA__database__USER=gitea_user
      - GITEA__database__PASSWD=gitea_pw
      - GITEA__server__DOMAIN=gitea.zoo
      - GITEA__server__ROOT_URL=http://gitea.zoo/
      - GITEA__server__HTTP_PORT=3000
      - GITEA__mailer__ENABLED=true
      - GITEA__mailer__HOST=stalwart:25
      - GITEA__mailer__FROM=noreply@gitea.zoo
      - GITEA__mailer__SKIP_VERIFY=true
      - GITEA__service__DISABLE_REGISTRATION=false
      - GITEA__service__REQUIRE_SIGNIN_VIEW=false
      - GITEA__service__REGISTER_EMAIL_CONFIRM=false
      - GITEA__service__ENABLE_NOTIFY_MAIL=true
      - GITEA__service__DEFAULT_KEEP_EMAIL_PRIVATE=false
      - GITEA__service__DEFAULT_ALLOW_CREATE_ORGANIZATION=true
      - GITEA__service__DEFAULT_ENABLE_TIMETRACKING=true
      - GITEA__cache__ENABLED=true
      - GITEA__cache__ADAPTER=redis
      - GITEA__cache__HOST=redis://redis:6379/0
      - USER_UID=1000
      - USER_GID=1000
      - SSL_CERT_FILE=/caddy-ca/pki/authorities/local/root.crt
    volumes:
      - caddy_data:/caddy-ca:ro
    labels:
      - "zoo.domains=gitea.zoo"
      - "zoo.description=Self-hosted Git service with web interface"
      - "zoo.icon=ðŸ™"
    healthcheck:
      <<: *zoo-healthcheck
      test: [
        "CMD",
        "curl",
        "-f",
        "-s",
        "-o",
        "/dev/null",
        "http://localhost:3000",
      ]
    profiles:
      - on-demand

  northwind:
    <<: *zoo-common
    image: phpmyadmin:5.2
    environment:
      - PMA_HOST=mysql
      - PMA_PORT=3306
      - PMA_USER=northwind_user
      - PMA_PASSWORD=northwind_pw
      - PMA_ARBITRARY=0
      - UPLOAD_LIMIT=300M
      - SSL_CERT_FILE=/caddy-ca/pki/authorities/local/root.crt
    volumes:
      - caddy_data:/caddy-ca:ro
    labels:
      - "zoo.domains=northwind.zoo:80"
      - "zoo.description=Northwind sample database with phpMyAdmin interface"
      - "zoo.icon=ðŸ—„ï¸"
    healthcheck:
      <<: *zoo-healthcheck
      test: ["CMD", "curl", "-f", "-s", "http://localhost:80/index.php"]
    profiles:
      - on-demand

  onestopshop:
    <<: *zoo-common
    image: ghcr.io/bgrins/vwa-shopping-optimized-standalone:1
    environment:
      - BASE_URL=https://onestopshop.zoo
      - MYSQL_PASSWORD=onestopshop_pw
      - MYSQL_USER=onestopshop_user
      - MYSQL_HOST=mysql
      - MYSQL_DATABASE=onestopshop_db
      - SSL_CERT_FILE=/caddy-ca/pki/authorities/local/root.crt
    volumes:
      - caddy_data:/caddy-ca:ro
    labels:
      - "zoo.domains=onestopshop.zoo:80"
      - "zoo.description=E-commerce shopping site from VisualWebArena"
      - "zoo.icon=ðŸ›ï¸"
    healthcheck:
      <<: *zoo-healthcheck
      test: ["CMD", "curl", "-f", "-s", "http://localhost:80/index.php"]
    profiles:
      - on-demand
      - heavy

  microbin:
    <<: *zoo-common
    image: danielszabo99/microbin:2.0.4
    environment:
      - MICROBIN_PORT=8080
      - MICROBIN_ADMIN_USERNAME=admin
      - MICROBIN_ADMIN_PASSWORD=zoopassword
      - MICROBIN_EDITABLE=true
      - MICROBIN_HIDE_FOOTER=true
      - MICROBIN_HIGHLIGHTSYNTAX=true
      - MICROBIN_TITLE=Zoo Pastebin
      - MICROBIN_QR=true
      - MICROBIN_ETERNAL_PASTA=true
      - MICROBIN_ENABLE_BURN_AFTER=false
      - MICROBIN_PUBLIC_PATH=https://paste.zoo
      - SSL_CERT_FILE=/caddy-ca/pki/authorities/local/root.crt
    volumes:
      - caddy_data:/caddy-ca:ro
    labels:
      - "zoo.domains=paste.zoo:8080"
      - "zoo.description=Self-hosted pastebin"
      - "zoo.icon=ðŸ“‹"
    healthcheck:
      <<: *zoo-healthcheck
      test:
        [
          "CMD",
          "bash",
          "-c",
          "echo -e 'GET / HTTP/1.0\r\n\r\n' > /dev/tcp/localhost/8080",
        ]
    profiles:
      - on-demand

  postmill:
    <<: *zoo-common
    image: ghcr.io/bgrins/vwa-reddit-optimized-standalone-slim:1
    environment:
      # {"username": "MarvelsGrantMan136", "password": "test1234"},
      - DATABASE_URL=postgresql://postmill_user:postmill_pw@postgres.zoo/postmill_db
      - APP_SECRET=zoo-postmill-secret-key
      - UPLOAD_HOST=postmill.zoo
      - UPLOAD_ROOT=https://postmill.zoo/
      - TRUSTED_PROXIES=REMOTE_ADDR
      - SSL_CERT_FILE=/caddy-ca/pki/authorities/local/root.crt
    volumes:
      - caddy_data:/caddy-ca:ro
    command:
      - sh
      - -c
      - |
          # Run original entrypoint setup
          /docker-entrypoint-standalone.sh true
          # Append config to .env.local
          echo "UPLOAD_HOST=$${UPLOAD_HOST}" >> /var/www/html/.env.local
          echo "UPLOAD_ROOT=$${UPLOAD_ROOT}" >> /var/www/html/.env.local
          echo "TRUSTED_PROXIES=$${TRUSTED_PROXIES}" >> /var/www/html/.env.local
          # Clear cache with new config
          php /var/www/html/bin/console cache:clear --env=prod --no-debug
          # Start supervisord to run nginx and PHP-FPM
          exec /usr/bin/supervisord -n -c /etc/supervisord.conf
    labels:
      - "zoo.domains=postmill.zoo:80"
      - "zoo.description=Reddit-like forum and link aggregator from VisualWebArena"
      - "zoo.icon=ðŸ’¬"
    healthcheck:
      <<: *zoo-healthcheck
      test: ["CMD", "wget", "-q", "-O-", "http://localhost:80/"]
    profiles:
      - on-demand
      - heavy

  analytics-zoo:
    <<: *zoo-common
    build: ./sites/apps/analytics.zoo
    environment:
      - MATOMO_DATABASE_HOST=mysql
      - MATOMO_DATABASE_ADAPTER=mysql
      - MATOMO_DATABASE_USERNAME=analytics_user
      - MATOMO_DATABASE_PASSWORD=analytics_pw
      - MATOMO_DATABASE_DBNAME=analytics_db
      - MATOMO_DATABASE_TABLES_PREFIX=matomo_
      - PHP_MEMORY_LIMIT=256M
      - SSL_CERT_FILE=/caddy-ca/pki/authorities/local/root.crt
    volumes:
      - caddy_data:/caddy-ca:ro
    labels:
      - "zoo.domains=analytics.zoo:80"
      - "zoo.description=Open-source web analytics platform"
      - "zoo.icon=ðŸ“Š"
    healthcheck:
      <<: *zoo-healthcheck
      test: [
        "CMD",
        "curl",
        "-f",
        "-s",
        "-o",
        "/dev/null",
        "http://localhost:80",
      ]
    profiles:
      - on-demand

  mattermost:
    <<: *zoo-common
    image: mattermost/mattermost-team-edition:10.5
    environment:
      # Server settings
      - MM_SERVICESETTINGS_SITEURL=http://mattermost.zoo
      - MM_SERVICESETTINGS_LISTENADDRESS=:8065
      - MM_SERVICESETTINGS_ENABLELOCALMODE=true
      # Database
      - MM_SQLSETTINGS_DRIVERNAME=postgres
      - MM_SQLSETTINGS_DATASOURCE=postgres://mattermost_user:mattermost_pw@postgres.zoo/mattermost_db?sslmode=disable
      # Team settings - allow open signup for dev
      - MM_TEAMSETTINGS_ENABLEOPENSERVER=true
      - MM_TEAMSETTINGS_ENABLEUSERDEACTIVATION=true
      # Email settings - configured for Stalwart SMTP
      - MM_EMAILSETTINGS_ENABLESIGNUPWITHEMAIL=true
      - MM_EMAILSETTINGS_ENABLESIGNINWITHEMAIL=true
      - MM_EMAILSETTINGS_ENABLESIGNINWITHUSERNAME=true
      - MM_EMAILSETTINGS_SENDEMAILNOTIFICATIONS=true
      - MM_EMAILSETTINGS_REQUIREEMAILVERIFICATION=false
      - MM_EMAILSETTINGS_SMTPSERVER=stalwart
      - MM_EMAILSETTINGS_SMTPPORT=25
      - MM_EMAILSETTINGS_ENABLESMTPAUTH=false
      - MM_EMAILSETTINGS_FEEDBACKNAME=Zoo Mattermost
      - MM_EMAILSETTINGS_FEEDBACKEMAIL=noreply@mattermost.zoo
      - MM_EMAILSETTINGS_REPLYTOADDRESS=noreply@mattermost.zoo
      - MM_EMAILSETTINGS_ENABLEPREVIEWMODEBANNER=false
      # Fixed encryption key for reproducible golden state
      - MM_SQLSETTINGS_ATRESTENCRYPTKEY=zoo-mattermost-encryption-key-32
      # File storage
      - MM_FILESETTINGS_DRIVERNAME=local
      - MM_FILESETTINGS_DIRECTORY=/mattermost/data
      # Logging
      - MM_LOGSETTINGS_CONSOLELEVEL=INFO
      - MM_LOGSETTINGS_ENABLEFILE=false
      # Plugin settings
      - MM_PLUGINSETTINGS_ENABLEUPLOADS=true
      # Service settings for local dev
      - MM_SERVICESETTINGS_ENABLETESTING=true
      - MM_SERVICESETTINGS_ENABLEDEVELOPER=true
      # Skip desktop app prompt and onboarding wizard
      - MM_SERVICESETTINGS_ENABLEDESKTOPLANDINGPAGE=false
      - MM_SERVICESETTINGS_ENABLEONBOARDINGFLOW=false
      - SSL_CERT_FILE=/caddy-ca/pki/authorities/local/root.crt
    volumes:
      - caddy_data:/caddy-ca:ro
    labels:
      - "zoo.domains=mattermost.zoo:8065"
      - "zoo.description=Team messaging and collaboration platform"
      - "zoo.icon=ðŸ’¬"
    healthcheck:
      <<: *zoo-healthcheck
      test: [
        "CMD",
        "curl",
        "-f",
        "-s",
        "http://localhost:8065/api/v4/system/ping",
      ]
    profiles:
      - on-demand

volumes:
  auth_zoo_modules:
  caddy_data:
